#jinja2:trim_blocks: False
# Generated by Ansible

{%- if item.force_remove_www %}
<VirtualHost *:80>
    ServerName www.{{ item.fqdn }}

    {%- if item.ssl and item.ssl.force_ssl %}
    Redirect permanent / https://{{ item.fqdn }}
    {%- else %}
    Redirect permanent / http://{{ item.fqdn }}
    {%- endif %}
</VirtualHost>
{%- endif %}

<VirtualHost *:80>
    ServerName {{ item.fqdn }}
    {%- if item.fqdn_alias %}
    ServerAlias {{ item.fqdn_alias }}
    {%- endif %}
    DocumentRoot "{{ item.app_dir }}"

    {%- if item.ssl and item.ssl.force_ssl %}
    Redirect permanent / https://{{ item.fqdn }}
    {%- endif %}

    ErrorLog  ${APACHE_LOG_DIR}/{{ item.fqdn }}.error.log
    CustomLog ${APACHE_LOG_DIR}/{{ item.fqdn }}.access.log combined

    <Directory />
        Order Deny,Allow
        Deny from all
    </Directory>

    <Directory "{{ item.app_dir }}">
        Order Allow,Deny
        Allow from all
        AllowOverride All
    </Directory>

    {%- if item.reverse_proxy or item.add_header %}
    <Location />
        {%- if item.add_header and item.add_header.auth %}
        Header merge Access-Control-Allow-Headers "Authorization"
        {%- endif %}

        {%- if item.reverse_proxy %}
        ProxyPass "{{ item.reverse_proxy.dest }}"
        ProxyPassReverse "{{ item.reverse_proxy.dest }}"
        {%- if item.reverse_proxy.preserve_host %}
        ProxyPreserveHost On
        {%- endif %}
        {%- endif %}
    </Location>
    {%- endif %}
</VirtualHost>

{% if item.ssl -%}

{%- if item.force_remove_www %}
<VirtualHost *:443>
    ServerName www.{{ item.fqdn }}

    Redirect permanent / https://{{ item.fqdn }}
</VirtualHost>
{%- endif %}

<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName {{ item.fqdn }}
    {%- if item.fqdn_alias %}
    ServerAlias {{ item.fqdn_alias }}
    {%- endif %}
    DocumentRoot "{{ item.app_dir }}"

    RewriteEngine On
    ErrorLog  ${APACHE_LOG_DIR}/{{ item.fqdn }}.ssl.error.log
    CustomLog ${APACHE_LOG_DIR}/{{ item.fqdn }}.ssl.access.log combined

    SSLEngine On
    SSLCertificateFile    "{{ item.ssl.cert.dest }}"
    SSLCertificateKeyFile "{{ item.ssl.key.dest }}"
    {%- if item.ssl.ca %}
    SSLCACertificateFile  "{{ item.ssl.ca.dest }}"
    {%- endif %}

    <Directory />
        Order Deny,Allow
        Deny from all
    </Directory>

    <Directory "{{ item.app_dir }}">
        Order Allow,Deny
        Allow from all
        AllowOverride All
    </Directory>

    <Location />
        {%- if item.ssl.add_header and item.ssl.add_header.auth %}
        Header merge Access-Control-Allow-Headers "Authorization"
        {%- endif %}

        SSLRequireSSL On
        SSLVerifyClient None
        SSLVerifyDepth 1
        SSLOptions +StdEnvVars +StrictRequire
        {%- if item.ssl.reverse_proxy %}
        ProxyPass "{{ item.ssl.reverse_proxy.dest }}"
        ProxyPassReverse "{{ item.ssl.reverse_proxy.dest }}"
        {%- if item.ssl.reverse_proxy.preserve_host %}
        ProxyPreserveHost On
        {%- endif %}
        {%- endif %}
    </Location>
</VirtualHost>
</IfModule>
{%- endif %}
